---
title: "Analysis of Trends and Patterns in Vocational Training in Odisha"
author: "Data, Policy, and Innovation Centre"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    number_sections: true
---

# Executive Summary

**Purpose**: This report analyzes trends and patterns in vocational training in Odisha using data from the Student Academic Management System (SAMS).

**Key Findings**: Enrollment trends indicate significant variations by gender and social category. 

**Recommendations**: Enhance outreach programs targeting underrepresented groups and improve course availability.

# Table of Contents

# Introduction

Vocational training plays a crucial role in enhancing employability and skill development in Odisha. This report aims to analyze...

# Data Description

The analysis uses data from the Student Academic Management System (SAMS), which includes variables such as...

# Analysis


```{r, echo=FALSE, eval=FALSE}


```


```{r, echo=FALSE, include=FALSE}
# Load the libraries
library(RSQLite)
library(DBI)
library(dplyr)
library(tidyverse)
library(kableExtra)
library(knitr)
library(reactable)
library(htmltools)
library(maps)
library(tmap)
library(jsonlite)
library(sf)
library(readxl)
library(stringdist)

```

```{r, echo=FALSE,include=FALSE}
con <- dbConnect(RSQLite::SQLite(), file.path("C:/Users/Admin/Documents/GitHub/sams/data/raw/sams.db"))

# Query data for ITI module for years 2017 to 2023
query <- "SELECT * FROM students WHERE module = 'ITI' AND year BETWEEN 2017 AND 2024;"

# Send query to the database
result <- dbSendQuery(con, query)

# Fetch the relevant data
student_data_iti <- dbFetch(result)

# Clear the result
dbClearResult(result)
dbDisconnect(con)

# Admitted students only 
student_iti_admis = student_data_iti %>%
  filter(admission_status == "Yes")

```

```{r, include=FALSE,echo=FALSE}
con <- dbConnect(RSQLite::SQLite(), file.path("C:/Users/Admin/Documents/GitHub/sams/data/raw/sams.db"))

# Query data for ITI module for years 2017 to 2023
query <- "SELECT * FROM students WHERE module = 'Diploma' AND year BETWEEN 2018 AND 2024;"

# Send query to the database
result <- dbSendQuery(con, query)

# Fetch the relevant data
student_data_dip <- dbFetch(result)

# Clear the result
dbClearResult(result)
dbDisconnect(con)



## Check the admission count each year
student_dip_admis = student_data_dip[!is.na(student_data_dip$sams_code),]

```

## Vocational Temp
```{r,eval=FALSE}
ITI_tenth_graduates_2023 <- student_iti_admis %>%
  filter(Qualifying_ExamName != "8th Pass") %>%
  filter(YearofPassing == year) %>%
  filter(year == 2023) %>%
  summarise(Admitted_ITI_Students_Male = sum(gender == "Male"),
            Admitted_ITI_Students_Female = sum(gender == "Female") )  # Count the number of students
print(ITI_tenth_graduates_2023) 


```


## Vocational Pipeline
```{r include=FALSE,eval=FALSE}

# ITI extract two variables from the json_column
student_iti_admis <- student_iti_admis %>%
  mutate(parsed_json = lapply(mark_data, fromJSON)) %>%  # Parse the JSON
  mutate(
    Qualifying_ExamName = sapply(parsed_json, function(x) x$ExamName),   # Extract variable1
    YearofPassing = sapply(parsed_json, function(x) x$YearofPassing)    # Extract variable2
  ) %>%
  select(-parsed_json)  # Remove the parsed_json column if not needed

# Polytechnics extract two variables from the json_column
# Done by Yashaswi. File name - 

# Trades for Various Qualifications 2023
iti_qual_trade_2023 = student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(Qualifying_ExamName) %>%
  summarise(number_of_trade = n_distinct(reported_branch_or_trade)) 

iti_2023 = student_iti_admis %>%
  filter(year == 2023) 

table(iti_2023$highest_qualification)



ITI_graduates_same_year <- student_iti_admis %>%
  filter(Qualifying_ExamName != "8th Pass") %>%
  filter(YearofPassing == year) %>%
  group_by(year) %>%   # Group by admission year
  summarise(Admitted_ITI_Students = n())  # Count the number of students

Dip_graduates_same_year <- student_dip_admis_dt_distinct %>%
  filter(exam_name == "10th") %>%
  filter(yearof_passing == year) %>%
  group_by(year) %>%
  summarise(Admitted_Dip_Students = n())  # Count the number of students


 

# Import 10th figures
tenth_count = read_excel("C:/Users/Admin/Box/Amitav/Skills/SAMS/data/external/tenth_plustwo_odisha.xlsx")

# Summarize the data by year, calculating the total pass, total fail, and total batch count
total_tenth_count <- tenth_count %>%
  group_by(Year, Gender) %>%
  summarise(
    total_pass = sum(Pass, na.rm = TRUE),
    total_fail = sum(Fail, na.rm = TRUE),
    total_batch = total_pass + total_fail
  ) %>%
  ungroup() %>%
  group_by(Year) %>%
  summarise(
    total_pass = sum(total_pass),
    total_fail = sum(total_fail),
    total_batch = total_pass + total_fail
  )


# Import admission count for +2 in from 2011 to 2023 from SAMS Dashboard
plus_two_admis <- read_excel("C:/Users/Admin/Box/Amitav/Skills/SAMS/data/external/tenth_plustwo_odisha.xlsx", 
    sheet = "plus_two")

plus_two_admis <- plus_two_admis %>% rename(year = Year)
total_tenth_count <- total_tenth_count %>% rename(year = Year)

total_tenth_count <- total_tenth_count %>% rename(total_tenth_batch = total_batch)
plus_two_admis <- plus_two_admis %>% rename(total_plus_two_admitted = student_admitted)

# Select only the columns you need from each dataframe
df1_selected <- plus_two_admis %>% select(year, total_plus_two_admitted)
df2_selected <- total_tenth_count %>% select(year, total_tenth_batch)

# Perform full_join based on 'Year'
pipeline_table <- df2_selected %>%
  full_join(df1_selected, by = "year") %>%
  full_join(ITI_graduates_same_year, by = "year") %>%
  full_join(Dip_graduates_same_year, by = "year") %>%
  arrange(year) %>%
  mutate(total_plus_two_admitted = gsub(",", "", total_plus_two_admitted)) %>%
  mutate(total_plus_two_admitted = as.numeric(total_plus_two_admitted)) 


remove(pipeline_table)

pipeline_table$residual = pipeline_table$total_tenth_batch - pipeline_table$total_plus_two_admitted - pipeline_table$Admitted_ITI_Students - pipeline_table$Admitted_Dip_Students

pipeline_table


# Replace 'df' with the name of your DataFrame and specify the file path
write.xlsx(pipeline_table, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/pipeline_all_year.xlsx")


student_iti_admis$diff_year_yearpassing = student_iti_admis$year - as.numeric(student_iti_admis$YearofPassing)  

ggplot(student_iti_admis, aes(x = diff_year_yearpassing)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(title = "Histogram of Year Difference", x = "Difference Between Years", y = "Count") +
  scale_x_continuous(limits = c(0, 30), 
                     breaks = seq(0, 30, by = 1))
```


# Students in ITIs
```{r}
## Total students in ITIs - Pvt vs Govt
iti_students_summary <- student_iti_admis %>%
  group_by(year) %>%
  summarise(
    total_students = n(),
    pvt_students = sum(typeof_institute == "Pvt."),
    gov_students = sum(typeof_institute == "Govt."),
    share_of_pvt = round((pvt_students / total_students) * 100, 2),  # Round to 1 decimal place
    share_of_gov = round((gov_students / total_students) * 100, 2)   # Round to 1 decimal place
  ) %>%
  filter(year != 2017)

write.xlsx(iti_students_summary, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/iti_students_pvt_gov.xlsx")


```


```{r}
for_pie_highest_qualification_ITI = student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(highest_qualification) %>%
  summarise(student_count = n(), .groups = "drop") %>%
  arrange(desc(student_count))

# Replace 'path/to/output.xlsx' with the desired file path
write.xlsx(for_pie_highest_qualification_ITI, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/highest_qual_ITI_2023_pie.xlsx")
  

for_pie_highest_qualification_Diploma = student_dip_admis_dt_distinct %>%
  filter(year == 2023) %>%
  group_by(highest_qualification_board_exam_name) %>%
  summarise(student_count = n(), .groups = "drop") %>%
  arrange(desc(student_count))

print(student_dip_admis_dt_distinct)
print(for_pie_highest_qualification_Diploma)
# Replace 'path/to/output.xlsx' with the desired file path
write.xlsx(for_pie_highest_qualification_Diploma, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/highest_qual_Diploma_2023_pie.xlsx")
  

```



```{r tables, echo=FALSE,include=FALSE, results='asis'}
#pipeline_table %>%
#  filter(year >= 2017) %>%
#  knitr::kable(caption = "Table __: Vocational Training Pipeline in Odisha", digits = 1) %>%
#  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)



```


## Demographics

```{r include=FALSE}
## Social Group composition in across years

# Function to calculate % for groups
calculate_percentage <- function(data, x) {
  data %>%
    group_by(year, {{x}}) %>%                              # Use the provided variable (x) for grouping
    summarise(count = n(), .groups = 'drop') %>%
    group_by(year) %>%                                      # Group by year for calculating percentage within each year
    mutate(Percentage = count / sum(count) * 100) %>%
    mutate(Percentage = round(Percentage, 1)) %>%
    ungroup() %>%
    select(year, {{x}}, Percentage) %>%
    pivot_wider(names_from = {{x}}, values_from = Percentage)  # Pivot based on the variable (x)
}

ITI_soc_grp <- calculate_percentage(student_iti_admis, social_category)
poly_soc_grp <- calculate_percentage(student_dip_admis, social_category)
ITI_religion <- calculate_percentage(student_iti_admis, religion_name)
poly_religion <- calculate_percentage(student_dip_admis, religion_name)
ITI_income_grp <- calculate_percentage(student_iti_admis, annual_income) %>%
  select("year", "0-1,00,000", "1,00,000-2,50,000", "2,50,000 - 6,00,000", "Above 6,00,000",  "More than 8,00,000",  "OTHER", "NA")
poly_income_grp <- calculate_percentage(student_dip_admis, annual_income) %>%
  select("year", "Upto 2.5 lakh","Between 2.5 To 8 lakh", "Above 8 lakh", "--")

# Function to calculate % for groups within General category
calculate_percentage_income <- function(data, x) {
  data %>%
    filter(social_category == "General") %>%               # Filter for "General" in social_category
    group_by(year, {{x}}) %>%                              # Group by year and the specified column (income group)
    summarise(count = n(), .groups = 'drop') %>%
    group_by(year) %>%                                      # Group by year for calculating percentage
    mutate(Percentage = count / sum(count) * 100) %>%
    mutate(Percentage = round(Percentage, 1)) %>%
    ungroup() %>%
    select(year, {{x}}, Percentage) %>%
    pivot_wider(names_from = {{x}}, values_from = Percentage)  # Pivot based on the variable (income group)
}

iti_general_income = calculate_percentage_income(student_iti_admis, annual_income)  %>%
  select("year", "0-1,00,000", "1,00,000-2,50,000", "2,50,000 - 6,00,000", "Above 6,00,000",  "More than 8,00,000",  "OTHER", "NA")
poly_general_income = calculate_percentage_income(student_dip_admis, annual_income) 

# Pivot table ITI for social_group and income_group in the year 2023
pivot_table_iti_inc_soc_2023 <- student_iti_admis %>%
  filter(year == 2023) %>%                                  # Filter for the year 2023
  group_by(social_category, annual_income) %>%               # Group by social_category and income_group
  summarise(count = n(), .groups = 'drop') %>%              # Count the number of students in each group
  group_by(social_category) %>%                             # Group by social_category to calculate percentage
  mutate(percentage = count / sum(count) * 100) %>%         # Calculate percentage for each income_group
  ungroup() %>%
  mutate(percentage = round(percentage, 1)) %>%             # Round the percentage to one decimal place
  select(-count) %>%                                        # Remove the count column
  pivot_wider(names_from = annual_income,                    # Pivot so that income_group becomes columns
              values_from = percentage,                     # Use the percentage as values
              values_fill = list(percentage = 0)) %>%
  select("social_category", "0-1,00,000", "1,00,000-2,50,000", "2,50,000 - 6,00,000",  "More than 8,00,000",  "OTHER", "NA")           # Fill missing combinations with 0
               # Fill missing combinations with 0

# Pivot table Polytechnics for social_group and income_group in the year 2023
pivot_table_dip_inc_soc_2023 <- student_dip_admis %>%
  filter(year == 2023) %>%                                  # Filter for the year 2023
  group_by(social_category, annual_income) %>%               # Group by social_category and income_group
  summarise(count = n(), .groups = 'drop') %>%              # Count the number of students in each group
  group_by(social_category) %>%                             # Group by social_category to calculate percentage
  mutate(percentage = count / sum(count) * 100) %>%         # Calculate percentage for each income_group
  ungroup() %>%
  mutate(percentage = round(percentage, 1)) %>%             # Round the percentage to one decimal place
  select(-count) %>%                                        # Remove the count column
  pivot_wider(names_from = annual_income,                    # Pivot so that income_group becomes columns
              values_from = percentage,                     # Use the percentage as values
              values_fill = list(percentage = 0)) %>%
  select(social_category, `Upto 2.5 lakh`,`Between 2.5 To 8 lakh`, `Above 8 lakh`, `--`)

```

```{r echo=FALSE, results='asis'}
ITI_soc_grp %>%
  knitr::kable(caption = "Table _: Social Category Composition ITIs (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_soc_grp %>% 
  knitr::kable(caption = "Table _: Social Category Composition Polytechnics (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = TRUE,       # Allows table to expand
                            position = "center",     # Center the table
                            font_size = 14) %>%      # Adjust font size
  kableExtra::column_spec(1:ncol(ITI_soc_grp), width = "2cm") 

ITI_religion %>%
  knitr::kable(caption = "Table _: Religion Composition ITI (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_religion %>%
  knitr::kable(caption = "Table _: Religion Composition Polytechnics (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

ITI_income_grp %>%
  knitr::kable(caption = "Table _: Income Group (Annual) Composition ITI (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_income_grp %>%
  knitr::kable(caption = "Table _: Income Group (Annual) Composition Polytechnics (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)
 
iti_general_income %>%
  knitr::kable(caption = "Table _: Income Group Composition Among General Category ITI (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_general_income %>%
  knitr::kable(caption = "Table _: Income Group Composition Among General Category Polytechnics (%)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

# Note - There is no "General" Category in Polytechnics

pivot_table_iti_inc_soc_2023 %>%
  knitr::kable(caption = "Table _: Social Category Income Group Matrix ITI in % (2023)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

pivot_table_dip_inc_soc_2023 %>%
  knitr::kable(caption = "Table _: Social Category Income Group Matrix Polytechnics in % (2023)", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

```



## Geography


```{r include=FALSE}
# Count the total number of students from each district across the years
total_students_district <- student_iti_admis %>%
  group_by(district, year) %>%  # Group by district and year
  summarise(Students_from_District = n(), .groups = 'drop')  # Count the number of students

# Institute_District
total_students_insti_district <- student_iti_admis %>%
  group_by(institute_district, year) %>%  # Group by district and year
  summarise(Students_Institute_District = n(), .groups = 'drop')  # Count the number of students


# Count the number of female students from each district in government ITIs across the years
female_govt_iti_students <- student_iti_admis %>%
  filter(gender == "Female" & typeof_institute == "Govt.") %>%  # Filter for females in govt. ITIs
  group_by(district, year) %>%  # Group by district and year
  summarise(female_students_home_dist = n(), .groups = 'drop')  # Count the number of female students

# Count the number of female students in institute district in government ITIs across the years
female_insti_govt_iti_students <- student_iti_admis %>%
  filter(gender == "Female" & typeof_institute == "Govt.") %>%  # Filter for females in govt. ITIs
  group_by(institute_district, year) %>%  # Group by district and year
  summarise(female_students_iti_district = n(), .groups = 'drop')  # Count the number of female students

# Students from each district 2023
total_students_district_2023 <- total_students_district %>%
  filter(year == 2023)

total_students_insti_district_2023 = total_students_insti_district %>%
  filter(year == 2023)

female_govt_iti_students_2023 <- female_govt_iti_students %>%
  filter(year == 2023) 

female_insti_govt_iti_students_2023 <-  female_insti_govt_iti_students %>%
  filter(year == 2023)

# Rename institute_district in the second dataframe to match with the district
female_insti_govt_iti_students_2023 <- female_insti_govt_iti_students_2023 %>%
  rename(district = institute_district)

# Perform the full join by 'district' and 'year'
combined_female_students_dist_2023 <- full_join(female_govt_iti_students_2023, 
                                      female_insti_govt_iti_students_2023, 
                                      by = c("district", "year"))


```


```{r echo=FALSE}

# Load the shapefile of Odisha districts
# Replace with the actual path to your shapefile
odisha_districts <- st_read("C:/Users/Admin/Box/Amitav/Skills/SAMS/data/external/odisha.kml")

# Load the district population 
india_districts_census_2011 <- read_csv("C:/Users/Admin/Box/Amitav/Skills/SAMS/data/external/india-districts-census-2011.csv")
odisha_pop_dist_2011 <- india_districts_census_2011 %>%
  filter(`State name` == "ORISSA")

odisha_pop_dist_2011 <- odisha_pop_dist_2011 %>% mutate(`District name` = toupper(`District name`))

odisha_pop_dist_2011 <- odisha_pop_dist_2011 %>%
  mutate(`District name` = case_when(
    `District name` == "BARGARH" ~ "BARAGARH",
    `District name` == "BALANGIR" ~ "BOLANGIR (BALANGIR)",
    `District name` == "BALESHWAR" ~ "BALASORE (BALESHWAR)",
    `District name` == "DEBAGARH" ~ "DEOGARH",
    `District name` == "KENDRAPARA" ~ "KENDRAPARHA",
    `District name` == "KENDUJHAR" ~ "KEONJHAR (KENDUJHAR)",
    `District name` == "JAGATSINGHAPUR" ~ "JAGATSINGHPUR",
    `District name` == "NUAPADA" ~"NUAPARHA",
    `District name` == "RAYAGADA" ~"RAYAGARHA",
    `District name` == "BAUDH" ~"BAUDH (BAUDA)",
    TRUE ~ `District name`  # Keep other district names unchanged
  ))

combined_female_students_dist_2023 <- combined_female_students_dist_2023 %>% mutate(district = toupper(district))

combined_female_students_dist_2023 <- combined_female_students_dist_2023 %>%
  mutate(district = case_when(
    district == "ANGUL" ~ "ANUGUL",
    district == "BOLANGIR" ~ "BOLANGIR (BALANGIR)",
    district == "BALASORE" ~ "BALASORE (BALESHWAR)",
    district == "JAJPUR" ~ "JAJAPUR",
    district == "KENDRAPARA" ~ "KENDRAPARHA",
    district == "KEONJHAR" ~ "KEONJHAR (KENDUJHAR)",
    district == "KHURDA" ~ "KHORDHA",
    district == "NAWARANGPUR" ~"NABARANGAPUR",
    district == "NUAPADA" ~"NUAPARHA",
    district == "RAYAGADA" ~"RAYAGARHA",
    district == "SONEPUR" ~"SUBARNAPUR",
    district == "BOUDH" ~"BAUDH (BAUDA)",
    TRUE ~ district  # Keep other district names unchanged
  ))



total_students_district_2023 <- total_students_district_2023 %>% mutate(district = toupper(district))

total_students_district_2023 <- total_students_district_2023 %>%
  mutate(district = case_when(
    district == "ANGUL" ~ "ANUGUL",
    district == "BOLANGIR" ~ "BOLANGIR (BALANGIR)",
    district == "BALASORE" ~ "BALASORE (BALESHWAR)",
    district == "JAJPUR" ~ "JAJAPUR",
    district == "KENDRAPARA" ~ "KENDRAPARHA",
    district == "KEONJHAR" ~ "KEONJHAR (KENDUJHAR)",
    district == "KHURDA" ~ "KHORDHA",
    district == "NAWARANGPUR" ~"NABARANGAPUR",
    district == "NUAPADA" ~"NUAPARHA",
    district == "RAYAGADA" ~"RAYAGARHA",
    district == "SONEPUR" ~"SUBARNAPUR",
    district == "BOUDH" ~"BAUDH (BAUDA)",
    TRUE ~ district  # Keep other district names unchanged
  ))

total_students_insti_district_2023 = total_students_insti_district_2023 %>% mutate(institute_district = toupper(institute_district))

total_students_insti_district_2023 <- total_students_insti_district_2023 %>%
  mutate(institute_district = case_when(
    institute_district == "ANGUL" ~ "ANUGUL",
    institute_district == "BOLANGIR" ~ "BOLANGIR (BALANGIR)",
    institute_district == "BALASORE" ~ "BALASORE (BALESHWAR)",
    institute_district == "JAJPUR" ~ "JAJAPUR",
    institute_district == "KENDRAPARA" ~ "KENDRAPARHA",
    institute_district == "KEONJHAR" ~ "KEONJHAR (KENDUJHAR)",
    institute_district == "KHURDA" ~ "KHORDHA",
    institute_district == "NAWARANGPUR" ~"NABARANGAPUR",
    institute_district == "NUAPADA" ~"NUAPARHA",
    institute_district == "RAYAGADA" ~"RAYAGARHA",
    institute_district == "SONEPUR" ~"SUBARNAPUR",
    institute_district == "BOUDH" ~"BAUDH (BAUDA)",
    TRUE ~ institute_district  # Keep other district names unchanged
  ))

odisha_districts <- odisha_districts %>%
  left_join(total_students_insti_district_2023, by = c("Name" = "institute_district"))

odisha_districts$Students_Institute_District_per_lakh = odisha_districts$Students_Institute_District/odisha_districts$Population*100000


# Step 4: Merge the ITI count data with the Odisha districts shapefile
odisha_districts <- odisha_districts %>%
  left_join(combined_female_students_dist_2023, by = c("Name" = "district"))

odisha_districts <- odisha_districts %>%
  left_join(odisha_pop_dist_2011, by = c("Name" = "District name"))

odisha_districts <- odisha_districts %>%
  left_join(total_students_district_2023, by = c("Name" = "district"))

# Calculate Girls from ITI Districts per Lakh population
odisha_districts$female_students_home_dist_per_lakh = odisha_districts$female_students_home_dist/odisha_districts$Population*100000

# Calculate Students from ITI Districts per Lakh population
odisha_districts$Students_from_District_per_lakh = odisha_districts$Students_from_District/odisha_districts$Population*100000




# Plotting Students Map
tmap_mode("plot")  # Change to "view" for interactive mode
map_student <- tm_shape(odisha_districts) +
  tm_polygons("Students_from_District", 
              title = "Number of Students in ITIs by Home District (2023)", 
              palette = "Blues", 
              n = 5) +
  tm_layout(main.title = "Number of Students in ITIs by Home District (2023)",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"),  # Attempting bottom right
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white", # Optional: Adds a background to legend for better visibility
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black")

# Add the interactive tooltip
map_student + tm_view(view.legend.position = c("right", "bottom"))


tmap_mode("view")  # Change to "view" for interactive mode
map_student_per_lakh <- tm_shape(odisha_districts) +
  tm_polygons("Students_from_District_per_lakh", 
              title = "Number of Students in ITIs by Home District (2023) Per Lakh Pop", 
              palette = "Blues", 
              n = 4) +
  tm_layout(main.title = "Number of Students in ITIs by Home District (2023) Per Lakh Pop",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"),  # Attempting bottom right
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white", # Optional: Adds a background to legend for better visibility
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black")

# Add the interactive tooltip
map_student_per_lakh + tm_view(view.legend.position = c("right", "bottom"))


odisha_districts$Students_Institute_District_per_lakh = odisha_districts$Students_Institute_District/odisha_districts$Population*100000

tmap_mode("view")  # Change to "view" for interactive mode
map_student_per_lakh <- tm_shape(odisha_districts) +
  tm_polygons("Students_Institute_District_per_lakh", 
              title = "Number of Students in ITIs by Institute District (2023) Per Lakh Pop", 
              palette = "Blues", 
              breaks = c(50, 100, 150, 200, 300),  # Manually set the intervals
              style = "fixed") +  # Use fixed style to apply specified intervals
  tm_layout(main.title = "Number of Students in ITIs by Institute District (2023) Per Lakh Pop",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"),
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white", 
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black")

# Add the interactive tooltip
map_student_per_lakh + tm_view(view.legend.position = c("right", "bottom"))


# Plotting with tmap Female Students
tmap_mode("view")  # Change to "view" for interactive mode
map <- tm_shape(odisha_districts) +
  tm_polygons("female_students_home_dist", 
              title = "Number of Girls in Govt ITIs by Home District (2023)", 
              palette = "Blues", 
              n = 5) +
  tm_layout(main.title = "Number of Girls in Govt ITIs by Home District (2023)",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"),  # Attempting bottom right
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white", # Optional: Adds a background to legend for better visibility
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black")

# Add the interactive tooltip
map


tmap_mode("plot")  # Change to "view" for interactive mode
map_per_lakh <- tm_shape(odisha_districts) +
  tm_polygons("female_students_home_dist_per_lakh", 
              title = "Number of Girls in Govt ITIs by Home District (2023) Per Lakh Pop", 
              palette = "Blues", 
              n = 4) +
  tm_layout(main.title = "Number of Girls in Govt ITIs by Home District (2023) Per Lakh Pop",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"),  # Attempting bottom right
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white", # Optional: Adds a background to legend for better visibility
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black")

# Add the interactive tooltip
map_per_lakh + tm_view(view.legend.position = c("right", "bottom"))


```


```{r}
# How many ITIs are in districts
iti_count_by_district <- student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district,typeof_institute) %>%
  summarise(
    total_itis = n_distinct(reported_institute),
    .groups = 'drop'  # This ensures summarise does not retain the grouping structure
  ) %>%
  pivot_wider(names_from = typeof_institute, values_from = total_itis, values_fill = 0) # Total number of ITIs

iti_count_by_district$total_itis <- iti_count_by_district$Govt. + iti_count_by_district$Pvt.
iti_count_by_district

iti_count_by_district <- iti_count_by_district %>% mutate(`institute_district` = toupper(`institute_district`))

iti_count_by_district <- iti_count_by_district %>%
  mutate(institute_district = case_when(
    institute_district == "ANGUL" ~ "ANUGUL",
    institute_district == "BOLANGIR" ~ "BOLANGIR (BALANGIR)",
    institute_district == "BALASORE" ~ "BALASORE (BALESHWAR)",
    institute_district == "JAJPUR" ~ "JAJAPUR",
    institute_district == "KENDRAPARA" ~ "KENDRAPARHA",
    institute_district == "KEONJHAR" ~ "KEONJHAR (KENDUJHAR)",
    institute_district == "KHURDA" ~ "KHORDHA",
    institute_district == "NAWARANGPUR" ~"NABARANGAPUR",
    institute_district == "NUAPADA" ~"NUAPARHA",
    institute_district == "RAYAGADA" ~"RAYAGARHA",
    institute_district == "SONEPUR" ~"SUBARNAPUR",
    institute_district == "BOUDH" ~"BAUDH (BAUDA)",
    TRUE ~ institute_district  # Keep other district names unchanged
  ))

# Merge the ITI count data with the Odisha districts shapefile
odisha_districts <- odisha_districts %>%
  left_join(iti_count_by_district, by = c("Name" = "institute_district"))

tmap_mode("view")
map_total_itis = tm_shape(odisha_districts) + 
  tm_polygons("total_itis", 
              title = "Number of ITIs", 
              palette = "Blues", 
              n = 4) +
  tm_layout(main.title = "Number of ITIs",
            main.title.size = 0.7,
            legend.position = c("right", "bottom"),
            legend.title.size = 0.2,
            legend.text.size = 0.1) +
  tm_borders(lwd = 1, col = "black")
map_total_itis + tm_view(view.legend.position = c("right", "bottom"))





```

# Temp - Analysis of District "Migration"
```{r}
table(student_iti_admis$district,student_iti_admis$institute_district)

# Subset ITI by "Other" in "district"
iti_district_other_2023 = student_iti_admis %>%
  filter(district %in% c("Other","Odisha","Skill Department (DTET)")) %>%
  filter(year == 2023)

iti_district_other_2023_state_mig <- iti_district_other_2023 %>%  
  group_by(state, institute_district) %>%  # Group by 'state' and 'institute_district'
  summarise(count = n(), .groups = 'drop')  # Count occurrences and ungroup

# Export
write_xlsx(iti_district_other_2023_state_mig, "C:/Users/Admin/Documents/incoming_ITI_students_from_states.xlsx")


# Inter district Within State migration
iti_interdistrict_mig_2023 <- student_iti_admis %>%  
  filter(!district %in% c("Other","Odisha","Skill Department (DTET)")) %>%
  filter(year == 2023) %>%
  group_by(district, institute_district) %>%  # Group by 'state' and 'institute_district'
  summarise(count = n(), .groups = 'drop')  # Count occurrences and ungroup
iti_interdistrict_mig_2023
# Export
write_xlsx(iti_interdistrict_mig_2023, "C:/Users/Admin/Documents/iti_interdistrict_mig_2023.xlsx")


# Number of people Leaving district 2023 select top 10 districts
leavers_by_district_2023 <- student_iti_admis %>%
  filter(year == 2023) %>%
  filter(!district %in% c("Other","Odisha","Skill Department (DTET)")) %>%
  group_by(district) %>%
  summarise(
    total_count = n(),  # Total number of people in each district
    leavers_count = sum(district != institute_district)  # Count people who leave their district
  ) %>%
  mutate(leavers_percentage = (leavers_count / total_count) * 100) %>%  # Calculate percentage
  arrange(desc(leavers_percentage)) %>%  # Sort by percentage in descending order
  slice_max(leavers_percentage,n=10)
leavers_by_district_2023
# The top 10 districts' leavers_percentage ranges from 31.6% to 57.1%

top_leaving_district_list = leavers_by_district_2023 %>%
  pull(district)
top_leaving_district_list
# Where are the leavers in top leaving states going
iti_interdistrict_mig_2023_selected <- student_iti_admis %>%  
  filter(district %in% top_leaving_district_list) %>%
  filter(year == 2023) %>%
  group_by(district, institute_district) %>%  # Group by 'state' and 'institute_district'
  summarise(count = n(), .groups = 'drop')  # Count occurrences and ungroup
iti_interdistrict_mig_2023_selected
# Export
write_xlsx(iti_interdistrict_mig_2023_selected, "C:/Users/Admin/Documents/iti_interdistrict_mig_topDist_2023.xlsx")


write_xlsx(leavers_by_district_2023, "C:/Users/Admin/Documents/leavers_by_district_2023.xlsx")

leavers_by_district_2023 <- leavers_by_district_2023 %>% mutate(district = toupper(district))

# Plot the number/percentage leaving district in 2023 
leavers_by_district_2023 <- leavers_by_district_2023 %>%
  mutate(district = case_when(
    district == "ANGUL" ~ "ANUGUL",
    district == "BOLANGIR" ~ "BOLANGIR (BALANGIR)",
    district == "BALASORE" ~ "BALASORE (BALESHWAR)",
    district == "JAJPUR" ~ "JAJAPUR",
    district == "KENDRAPARA" ~ "KENDRAPARHA",
    district == "KEONJHAR" ~ "KEONJHAR (KENDUJHAR)",
    district == "KHURDA" ~ "KHORDHA",
    district == "NAWARANGPUR" ~"NABARANGAPUR",
    district == "NUAPADA" ~"NUAPARHA",
    district == "RAYAGADA" ~"RAYAGARHA",
    district == "SONEPUR" ~"SUBARNAPUR",
    district == "BOUDH" ~"BAUDH (BAUDA)",
    TRUE ~ district  # Keep other district names unchanged
  ))


odisha_districts <- odisha_districts %>%
  left_join(leavers_by_district_2023, by = c("Name" = "district"))

tmap_mode("view")  # Change to "view" for interactive mode
map_leavers <- tm_shape(odisha_districts) +
  tm_polygons("leavers_percentage", 
              title = "Percentage of Students from District studying outside (2023)", 
              palette = "Blues", 
              n = 4) +
  tm_layout(main.title = "Percentage of Students from District studying outside (2023)",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"), 
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white",
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black") 
map_leavers + tm_view(view.legend.position = c("right", "bottom"))


## Top Hosting Districts for students within Odisha
receivers_by_district_2023 <- student_iti_admis %>%
  filter(year == 2023) %>%
  filter(!district %in% c("Other","Odisha","Skill Department (DTET)")) %>%
  group_by(institute_district) %>%
  summarise(
    total_count = n(),  # Total number of people in each district
    receivers_count = sum(district != institute_district)  # Count people who come to district
  ) %>%
  mutate(receivers_percentage = (receivers_count / total_count) * 100) %>%  # Calculate percentage
  arrange(desc(receivers_percentage)) %>%  # Sort by percentage in descending order
  slice_max(receivers_percentage,n=10)
leavers_by_district_2023



```





## Institutions

```{r, echo=FALSE}

## Student count in ITIs
iti_student_count = student_iti_admis %>%
  group_by(year,typeof_institute) %>%
  summarise(student_count = n(), .groups = "drop")

# Pivot the data wider to have separate columns for Pvt. and Govt. institutes
iti_student_count_pivoted <- iti_student_count %>%
  pivot_wider( 
    names_from = typeof_institute, 
    values_from = student_count, 
    values_fill = 0  # Fill missing values with 0
  )

# Calculate total students and share of Govt. students
iti_student_count_summary <- iti_student_count_pivoted %>%
  # Create a new column for total institutes and share of Govt. institutes, rounded to 1 decimal
  mutate(total_students = Govt. + Pvt.,
         share_of_govt = round((Govt. / total_students) * 100, 1)) %>%
  # Select only the necessary columns
  select(year, total_students, share_of_govt)


## Student count in Polytechnics
dip_student_count = student_dip_admis %>%
  group_by(year,typeof_institute) %>%
  summarise(student_count = n(), .groups = "drop")

# Pivot the data wider to have separate columns for Pvt. and Govt. institutes
dip_student_count_pivoted <- dip_student_count %>%
  pivot_wider( 
    names_from = typeof_institute, 
    values_from = student_count, 
    values_fill = NA  # Fill missing values with NA
  )

# Calculate total students and share of Govt. students
dip_student_count_summary <- dip_student_count_pivoted %>%
  # Create a new column for total institutes and share of Govt. institutes, rounded to 1 decimal
  mutate(total_students = Govt. + Pvt.,
         share_of_govt = round((Govt. / total_students) * 100, 1)) %>%
  # Select only the necessary columns
  select(year, total_students, share_of_govt)



# Student count in ITIs across districts
#iti_student_dist_count = student_iti_admis %>%
#  group_by(year,institute_district,typeof_institute,reported_institute) %>%
#  summarise(student_count = n(), .groups = "drop")
#view(iti_student_count)
# Student count in Polytechnics across districts
#poly_student_dist_count = student_dip_admis %>%
#  group_by(year,institute_district,typeof_institute,reported_institute) %>%
#  summarise(student_count = n(), .groups = "drop")


# ITI Count
iti_institutes_count = student_iti_admis %>%
  group_by(year,typeof_institute) %>%
  summarise(ITI_count = n_distinct(reported_institute), .groups = "drop")

# Pivot the data wider to have separate columns for Pvt. and Govt. institutes
iti_institutes_count_pivoted <- iti_institutes_count %>%
  pivot_wider( 
    names_from = typeof_institute, 
    values_from = ITI_count, 
    values_fill = 0  # Fill missing values with 0
  )

# Calculate total students and share of Govt. students
iti_institutes_count_pivoted_summary <- iti_institutes_count_pivoted %>%
  # Create a new column for total institutes and share of Govt. institutes, rounded to 1 decimal
  mutate(total_institutes = Govt. + Pvt.,
         share_of_govt = round((Govt. / total_institutes) * 100, 1)) %>%
  # Select only the necessary columns
  select(year, total_institutes, share_of_govt)

# Polytechnics Count
poly_institutes_count = student_dip_admis %>%
  group_by(year,typeof_institute) %>%
  summarise(poly_count = n_distinct(reported_institute), .groups = "drop")

# Pivot the data wider to have separate columns for Pvt. and Govt. institutes
poly_institutes_count_pivoted <- poly_institutes_count %>%
  pivot_wider( 
    names_from = typeof_institute, 
    values_from = poly_count, 
    values_fill = 0  # Fill missing values with 0
  )

# Calculate total students and share of Govt. students
poly_institutes_count_pivoted_summary <- poly_institutes_count_pivoted %>%
  # Create a new column for total institutes and share of Govt. institutes, rounded to 1 decimal
  mutate(total_institutes = Govt. + Pvt.,
         share_of_govt = round((Govt. / total_institutes) * 100, 1)) %>%
  # Select only the necessary columns
  select(year, total_institutes, share_of_govt)




# Poly Count across districts
#poly_institutes_count = student_dip_admis %>%
#  group_by(year,institute_district,typeof_institute) %>%
#  summarise(Polytechnics_count = n_distinct(reported_institute), .groups = "drop")


# Plot the district-wise institute count 

# Institutes with highest enrollment 2023
# ITI
iti_level_student_count = student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district,typeof_institute,reported_institute) %>%
  summarise(student_count = n(), .groups = "drop") %>%
  select(reported_institute, student_count, typeof_institute, institute_district) %>%
    arrange(desc(student_count)) %>%
    slice_head(n = 10)


write.xlsx(iti_level_student_count, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/top_10_ITIs_by_student_enrollment_2023.xlsx")
# Polytechnics
poly_level_student_count = student_dip_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district,typeof_institute,reported_institute) %>%
  summarise(student_count = n(), .groups = "drop") %>%
  select(reported_institute, student_count, typeof_institute, institute_district) %>%
  arrange(desc(student_count)) %>%
  slice_head(n = 10)

# Institutes with highest female enrollment 2023
# ITI
# ITI Level Female Student Count with Total Students and Total Gov ITIs
iti_level_fem_student_count = student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district, typeof_institute, reported_institute) %>%
  summarise(female_students = sum(gender == "Female"),total_students = n(), .groups = "drop") %>%
  arrange(desc(female_students)) %>%
  slice_head(n = 10) %>%
  select(reported_institute, female_students, total_students, typeof_institute, institute_district)

# Polytechnics
poly_level_fem_student_count = student_dip_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district,typeof_institute,reported_institute) %>%
  summarise(female_students = sum(gender=="Female"), .groups = "drop") %>%
  select(reported_institute, female_students, typeof_institute, institute_district) %>%
  arrange(desc(female_students)) %>%
  slice_head(n = 10)

# Count total number of government ITIs in each district
total_gov_itis = student_iti_admis %>%
  filter(year == 2023, typeof_institute == "Govt.") %>%
  group_by(institute_district) %>%
  summarise(total_gov_itis = n_distinct(reported_institute), .groups = "drop")

# Join the government ITI count to the female student count data frame
iti_level_fem_student_count = iti_level_fem_student_count %>%
  left_join(total_gov_itis, by = "institute_district") %>%
  mutate(Female_Share_Percent = round((female_students / total_students) * 100, 1)) %>% # Calculate Female Share (%)
  select(reported_institute, female_students, total_students, Female_Share_Percent, typeof_institute, institute_district, total_gov_itis)  # Reorder columns


# Polytechnics Level Female Student Count with Total Students and Total Gov ITIs
poly_level_fem_student_count = student_dip_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district, typeof_institute, reported_institute) %>%
  summarise(female_students = sum(gender == "Female"),
            total_students = n(),  # Total students (male + female)
            .groups = "drop") %>%
  select(reported_institute, female_students, total_students, typeof_institute, institute_district) %>%
  arrange(desc(female_students)) %>%
  slice_head(n = 10)

# Count total number of government Polytechnics in each district for Polytechnics
total_gov_poly_itis = student_dip_admis %>%
  filter(year == 2023, typeof_institute == "Govt.") %>%
  group_by(institute_district) %>%
  summarise(total_gov_polytechnics = n_distinct(reported_institute), .groups = "drop")


# count of available trades in ITIs 2023
iti_trade_count = student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district, reported_institute, typeof_institute) %>%
  summarise(trade_count = n_distinct(reported_branch_or_trade), .groups = "drop") %>%
  arrange(desc(trade_count)) %>% 
  select(reported_institute, trade_count, typeof_institute,institute_district) %>%
  slice_head(n = 10)
write.xlsx(iti_trade_count, "C:/Users/Admin/Box/3. Sudakshya/4. Presentation/number_of_trades_in_top_ITIs_2023.xlsx")


# count of available trades in ITIs 2023
poly_trade_count = student_dip_admis %>%
  filter(year == 2023) %>%
  group_by(institute_district, reported_institute, typeof_institute) %>%
  summarise(branch_count = n_distinct(reported_branch_or_trade), .groups = "drop") %>%
  arrange(desc(branch_count)) %>% 
  select(reported_institute, branch_count, typeof_institute,institute_district) %>%
  slice_head(n = 10)


ITI_talcher = student_iti_admis %>% 
  filter(year == 2023) %>% 
  filter(reported_institute %in% c("ITI Berhampur, Ganjam", "ITI Bhubaneswar, Khurda", "ITI Cuttack", "ITI Barbil, Keonjhar", "Madhusudan ITI, Cuttack", "ITI Talcher, Anugul"))

Talcher_trade = ITI_talcher %>% 
  group_by(reported_institute, reported_branch_or_trade) %>%
  summarise(trade_count = n(),
            female_trade_count = sum(gender == "Female"))

selected_institute_trade_matrix <- Talcher_trade  %>%
  select(-trade_count) %>%
  pivot_wider(names_from = reported_institute, values_from = female_trade_count) 


```


```{r tables_institutions, echo=FALSE, results='asis'}
iti_student_count_summary %>%
  knitr::kable(caption = "Table _: Count of ITI Students", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

dip_student_count_summary %>%
  knitr::kable(caption = "Table _: Count of Polytechnic Students", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

iti_institutes_count_pivoted_summary %>%
  knitr::kable(caption = "Table _: Count of ITIs", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_institutes_count_pivoted_summary  %>%
  knitr::kable(caption = "Table _: Count of Polytechnics", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

iti_level_student_count  %>%
  knitr::kable(caption = "Table _: Top 10 ITIs with Highest Student Enrollment", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_level_student_count  %>%
  knitr::kable(caption = "Table _: Top 10 Polytechnics with Highest Student Enrollment", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

iti_level_fem_student_count  %>%
  knitr::kable(caption = "Table _: Top 10 ITIs with Highest Female Student Enrollment", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_level_fem_student_count  %>%
  knitr::kable(caption = "Table _: Top 10 Polytechnics with Highest Female Student Enrollment", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)


reactable_selected_institute_trade_matrix <- reactable(
  selected_institute_trade_matrix, 
  sortable = TRUE, 
  defaultPageSize = 27,
  theme = reactableTheme(
    style = list(fontFamily = "Arial, sans-serif", fontSize = "14px")  # Change the font and size
  )
)

# Add the caption using htmlwidgets::prependContent, with custom font styling
htmlwidgets::prependContent(
  reactable_selected_institute_trade_matrix,
  tags$h3(
    style = "font-family: 'Arial', serif; font-size: 20px; font-weight: bold; color: black;",
    "Top 10 Trades Female Students in Selected ITIs (2023)"
  )
)

iti_trade_count  %>%
  knitr::kable(caption = "Table _: Top 10 ITIs with Highest Number of Trades", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

poly_trade_count  %>%
  knitr::kable(caption = "Table _: Top 10 Polytechnics with Highest Number of Branches", digits = 1) %>%
  kableExtra::kable_styling(bootstrap_options = "striped",full_width = FALSE)

```

# ITIs in Districts per Millions 
```{r}
## Count of ITIs per 100,000 population
odisha_districts$total_itis_per_cap = odisha_districts$Name
view(odisha_districts)

odisha_districts_population <- odisha_pop_dist_2011 %>%
  select(`District name`, Population)


merged_iti_count_per_cap <- left_join(odisha_districts_population, odisha_districts, by = c("District name" = "Name"))

merged_iti_count_per_cap$total_iti_per_cap = merged_iti_count_per_cap$total_itis/merged_iti_count_per_cap$Population * 1000000
merged_iti_count_per_cap$total_iti_per_cap

sorted_merged_iti_count_per_cap <- merged_iti_count_per_cap %>%
  mutate(total_iti_per_cap = round(total_iti_per_cap, 1)) %>%
  select(`District name`, total_iti_per_cap,Pvt.,Govt.) %>%  # Select only district names and total_iti_per_cap
  arrange(desc(total_iti_per_cap)) 
view(sorted_merged_iti_count_per_cap)

odisha_districts <- left_join(odisha_districts, sorted_merged_iti_count_per_cap, by = c("Name" = "District name"))

tmap_mode("view")  # Change to "view" for interactive mode
map_count_iti_cap <- tm_shape(odisha_districts) +
  tm_polygons("total_iti_per_cap", 
              title = "Count of ITIs per million population (2023)", 
              palette = "Blues", 
              n = 4) +
  tm_layout(main.title = "Count of ITIs per million population (2023)",
            main.title.size = 1.2,
            legend.position = c("right", "bottom"), 
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.bg.color = "white",
            legend.bg.alpha = 0.7) +
  tm_borders(lwd = 3, col = "black") 
map_count_iti_cap + tm_view(view.legend.position = c("right", "bottom"))



```


```{r}
  
# Replace the path with the actual path to your .shp file
path <- "C:/Users/Admin/Desktop/block_shapefiles"
odisha_blocks <- st_read(file.path(path,"Odisha_Admin_Block_BND_2021.shp"))

view(odisha_blocks)
geometry_file <- student_iti_admis %>% 
  select(district) %>% 
  distinct()




geometry_file <- geometry_file %>%
  mutate(district_2 = case_when(
    district == "Angul" ~ "Anugul",
    district == "Kendrapara" ~ "Kendrapada",
    district == "Balasore" ~ "Baleswar",
    district == "Jagatsinghpur" ~ "Jagatsingpur",
    district == "Malkangiri" ~ "Malkanagiri",
    district == "Odisha" ~ NA,
    district == "Skill Department (DTET)" ~ NA, 
    district == "Other" ~ NA,
    TRUE ~ district  # Keep other district names unchanged
  ))

# Join the student_data with the corrected district_2 from geometry_file
student_iti_admis <- student_iti_admis %>%
  left_join(geometry_file %>% select(district, district_2), by = "district")


#dist_not_in_master_block <- geometry_file %>%
#  anti_join(block_name_list_master, by = c("district" = "district_n"))


student_iti_admis <- student_iti_admis %>% 
  mutate(block_name_normalized = str_remove(block, "\\s*\\(.*?\\)")) %>% 
  mutate(block_name_normalized = tolower(block_name_normalized))

table(student_iti_admis$block,student_iti_admis$block_name_normalized)

odisha_blocks <- odisha_blocks %>% 
  mutate(block_name_normalized = str_remove(block_name, "\\s*\\(.*?\\)")) %>% 
  mutate(block_name_normalized = tolower(block_name_normalized))

student_iti_admis <- student_iti_admis %>%
  mutate(block_name_normalized = str_remove_all(block_name_normalized, "\\s*\\(?(S|s)adar\\)?"))

odisha_blocks <- odisha_blocks %>% 
  mutate(block_name_normalized = str_remove_all(block_name_normalized, "\\s*\\(?(S|s)adar\\)?"))

view(odisha_blocks$block_name_normalized)
view(unique(student_iti_admis$block_name_normalized))

n_distinct(student_iti_admis$block_name_normalized)

# Block-level students count in 2023
iti_2023_block_level <- student_iti_admis %>%
  filter(!is.na(district_2)) %>%
  filter(year == 2023) %>%
  group_by(block_name_normalized) %>%
  summarise(student_count = n(), .groups = "drop")



blocks_not_in_master_block <- iti_2023_block_level %>%
  anti_join(odisha_blocks, by = c("block_name_normalized" = "block_name_normalized"))




iti_block_with_special_chars_or_multiple_words <- blocks_not_in_master_block %>%
  filter(grepl("\\s", block_name_normalized) | grepl("[[:punct:]]", block_name_normalized))
view(iti_block_with_special_chars_or_multiple_words)

shp_block_with_special_chars_or_multiple_words <- odisha_blocks %>%
  filter(grepl("\\s", block_name_normalized) | grepl("[[:punct:]]", block_name_normalized))
view(shp_block_with_special_chars_or_multiple_words)

districts_from_iti <- 



fuzzy_match_blocks <- function(student_block,master_block,threshold = 3) {
  match_results <- character(length(student_block))
  for(i in seq_along(student_block)) {
    distance <- stringdist::stringdist(student_block[i],master_block,method = "osa")
    best_match <- master_block[which.min(distance)]
    if (min(distance) <= threshold) {
      match_results[i] <- best_match
    } else {
      match_results[i] <- NA
    }
  }
  return(match_results)
}

iti_2023_block_level <- iti_2023_block_level %>%
  mutate(matched_block = fuzzy_match_blocks(block_name_normalized, odisha_blocks$block_name_normalized, threshold = 3))
view(iti_2023_block_level)

view(odisha_blocks$block_name)

view(odisha_blocks)
    block == 
    block == 
    block_name_normalized == "balasore" ~ "baleswar",
    block == 
    block == 

view(odisha_blocks)
    
      
fuzzy_matches <-   
  
```


## Trade/Branch
```{r,echo=FALSE,include=FALSE}
## Top 10 trades among Male and Female 2023
top_trades_gender <- student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(gender, reported_branch_or_trade, course_period) %>%
  summarise(student_count = n(), .groups = 'drop') %>%
  arrange(gender, desc(student_count))

# Step 2: Get top 10 trades for male students
top_male_trades <- top_trades_gender %>%
  filter(gender == "Male") %>%
  top_n(10, student_count)

# Step 3: Get top 10 trades for female students
top_female_trades <- top_trades_gender %>%
  filter(gender == "Female") %>%
  top_n(10, student_count)

# Step 4: Combine results and include 'course_period'
top_trades_combined_gender <- bind_rows(
  top_male_trades %>% mutate(gender = "Male"),
  top_female_trades %>% mutate(gender = "Female")
)
# Pivot the data to have trades as columns and include course_period
pivoted_result <- top_trades_combined_gender %>%
  select(gender, reported_branch_or_trade, student_count, course_period) %>%  # Select relevant columns
  distinct() %>%  # Ensure unique rows
  pivot_wider(names_from = gender, values_from = student_count) %>%
  select(reported_branch_or_trade, Male, Female, course_period)



## Top 10 trades among Pvt. and Govt. ITIs 2023
top_trades_iti <- student_iti_admis %>%
  filter(year == 2023) %>%
  group_by(typeof_institute, reported_branch_or_trade, course_period) %>%
  summarise(student_count = n(), .groups = 'drop') %>%
  arrange(typeof_institute, desc(student_count))

# Step 2: Get top 10 trades for Gov. ITIs
top_gov_trades <- top_trades_iti %>%
  filter(typeof_institute == "Govt.") %>%
  top_n(10, student_count)

# Step 3: Get top 10 trades for Pvt. ITIs
top_pvt_trades <- top_trades_iti %>%
  filter(typeof_institute == "Pvt.") %>%
  top_n(10, student_count)

# Combine results for both Gov. and Pvt. ITIs
top_trades_combined_type <- bind_rows(
  top_gov_trades %>% mutate(typeof_institute = "Govt."),
  top_pvt_trades %>% mutate(typeof_institute = "Pvt.")
)

# Pivot the data so that each trade has Govt and Pvt columns with student counts
pivot_top_trades <- top_trades_combined_type %>%
  pivot_wider(
    names_from = typeof_institute,  # Create columns based on 'institute_type' (Gov and Pvt)
    values_from = student_count  # Use 'student_count' as the values for the new columns
  ) %>%
  select(reported_branch_or_trade,`Govt.`,`Pvt.`,course_period)


## Top trades in Social Categories over time
trade_count_by_social_category <- student_iti_admis %>%
  group_by(year, social_category, reported_branch_or_trade) %>%
  summarise(trade_count = n(), .groups = 'drop') %>%
  arrange(year, social_category, desc(trade_count)) # Arrange for top trades selection

# Select the top 5 trades within each social category in each year
top_trades_within_social_categories <- trade_count_by_social_category %>%
  group_by(year, social_category) %>%
  slice_head(n = 5) %>%  # Select top 5 trades
  ungroup() # Ungroup to remove grouping after selection

# Filter out the year 2017
top_trades_within_social_categories <- top_trades_within_social_categories %>%
  filter(year != 2017 & year != 2024)

## Top trades in Gender over time
trade_count_by_gender <- student_iti_admis %>%
  group_by(year, gender, reported_branch_or_trade) %>%
  summarise(trade_count = n(), .groups = 'drop') %>%
  arrange(year, gender, desc(trade_count)) # Arrange for top trades selection

# Select the top 5 trades within each social category in each year
top_trades_within_gender <- trade_count_by_gender %>%
  group_by(year, gender) %>%
  slice_head(n = 5) %>%  # Select top 5 trades
  ungroup() # Ungroup to remove grouping after selection

# Filter out the year 2017
top_trades_within_gender <- top_trades_within_gender %>%
  filter(year != 2017 & year != 2024) %>%
  filter(gender != "Transgender")


```


```{r echo=FALSE, results='asis'}
## Top Trades in 2023 In Govt. & Pvt. Institutes 
# Create an interactive table with sorting
reactable_table_trade_insti <- reactable(
  pivot_top_trades, 
  sortable = TRUE, 
  defaultPageSize = 27,
  theme = reactableTheme(
    style = list(fontFamily = "Arial, sans-serif", fontSize = "14px")  # Change the font and size
  )
)

# Add the caption using htmlwidgets::prependContent, with custom font styling
htmlwidgets::prependContent(
  reactable_table_trade_insti,
  tags$h3(
    style = "font-family: 'Arial', serif; font-size: 20px; font-weight: bold; color: black;",
    "Top 10 Trades by Student Count in Government and Private ITIs (2023)"
  )
)

# Top Trades in Top 10 Among Male & Female
reactable_table_trade_gender <- reactable(
  pivoted_result, 
  sortable = TRUE, 
  defaultPageSize = 27,
  theme = reactableTheme(
    style = list(fontFamily = "Arial, sans-serif", fontSize = "14px")  # Change the font and size
  )
)

# Add the caption using htmlwidgets::prependContent, with custom font styling
htmlwidgets::prependContent(
  reactable_table_trade_gender,
  tags$h3(
    style = "font-family: 'Arial', serif; font-size: 20px; font-weight: bold; color: black;",
    "Top 10 Trades by Student Count by Gender (2023)"
  )
)


```

```{r echo=FALSE}
# Create the line chart
ggplot(top_trades_within_social_categories, aes(x = year, y = trade_count, color = reported_branch_or_trade, group = reported_branch_or_trade)) +
  geom_line(size = 1) + # Draw lines for each trade
  geom_point(size = 2) + # Add points at each year for better visibility
  facet_wrap(~ social_category, scales = "free_y") + # Create a separate plot for each social category
  labs(
    title = "Top 5 Trades by Social Category Over the Years (Excluding 2017)",
    x = "Year",
    y = "Trade Count",
    color = "Trade"
  ) +
  theme_minimal() + # Use a minimal theme for a clean look
  theme(
    text = element_text(size = 12), # Adjust text size for better readability
    legend.position = "bottom", # Position legend at the bottom
    legend.title = element_text(size = 10), # Adjust legend title size
    legend.text = element_text(size = 8), # Adjust legend text size
    legend.key.size = unit(0.5, "cm") # Reduce the size of the legend keys
  ) +
  guides(color = guide_legend(ncol = 3)) # Arrange legend items in three columns

# Create the line chart
ggplot(top_trades_within_gender, aes(x = year, y = trade_count, color = reported_branch_or_trade, group = reported_branch_or_trade)) +
  geom_line(size = 1) + # Draw lines for each trade
  geom_point(size = 2) + # Add points at each year for better visibility
  facet_wrap(~ gender, scales = "free_y") + # Create a separate plot for each social category
  labs(
    title = "Top 5 Trades by Gender Over the Years (Excluding 2017)",
    x = "Year",
    y = "Trade Count",
    color = "Trade"
  ) +
  theme_minimal() + # Use a minimal theme for a clean look
  theme(
    text = element_text(size = 12), # Adjust text size for better readability
    legend.position = "bottom", # Position legend at the bottom
    legend.title = element_text(size = 10), # Adjust legend title size
    legend.text = element_text(size = 8), # Adjust legend text size
    legend.key.size = unit(0.5, "cm") # Reduce the size of the legend keys
  ) +
  guides(color = guide_legend(ncol = 3)) # Arrange legend items in three columns

```

